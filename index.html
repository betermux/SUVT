<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin - Khalk Store</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background: #000;
    color: #fff;
  }
  header {
    background: #222;
    padding: 20px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    color: #f00;
    border-bottom: 2px solid #f00;
  }
  .search-container {
    margin: 20px;
    text-align: center;
  }
  #search {
    padding: 10px;
    width: 300px;
    border: 2px solid #f00;
    background: #333;
    color: #fff;
    font-size: 16px;
  }
  #search:focus {
    outline: none;
    border-color: #ff4d4d;
  }
  table {
    width: 95%;
    border-collapse: collapse;
    margin: 20px auto;
    background: #222;
    border: 1px solid #f00;
  }
  th,
  td {
    padding: 10px;
    text-align: left;
    border: 1px solid #444;
  }
  th {
    background: #f00;
    color: #000;
  }
  .product-img {
    width: 80px;
    height: 80px;
    border-radius: 8px;
  }
  .btn-approve {
    background: #f00;
    color: #000;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s ease;
  }
  .btn-approve:hover {
    background: #ff4d4d;
  }
  h2 {
    color: #f00;
    margin-left: 20px;
  }
</style>
</head>
<body>

<header>Admin - Khalk Store Захиалгын Панел</header>

<div class="search-container">
  <input type="text" id="search" placeholder="Код эсвэл дүнгээр хайх..." />
</div>

<h2>Зөвшөөрөгдөөгүй захиалгууд</h2>
<table id="orderTable">
  <thead>
    <tr>
      <th>Код</th>
      <th>Бараа</th>
      <th>Дүн</th>
      <th>Огноо</th>
      <th>Үйлдэл</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Зөвшөөрөгдсөн захиалгууд</h2>
<table id="approvedOrderTable">
  <thead>
    <tr>
      <th>Код</th>
      <th>Бараа</th>
      <th>Дүн</th>
      <th>Огноо</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  // Firebase тохиргоо
  const firebaseConfig = {
    apiKey: "AIzaSyAEybA-Ou_PGkZINDT-opzVPUlrr6XOU8E",
    authDomain: "khalkh-store.firebaseapp.com",
    databaseURL: "https://khalkh-store-default-rtdb.firebaseio.com",
    projectId: "khalkh-store",
    storageBucket: "khalkh-store.firebasestorage.app",
    messagingSenderId: "205879441792",
    appId: "1:205879441792:web:677a6abe7912d6436a2965",
    measurementId: "G-6M9HZM8G9N"
  };

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();

  let allOrders = [];
  let approvedOrders = [];

  // Захиалгуудыг унших
  function loadOrders() {
    db.ref('paymentCodes').once('value').then(snapshot => {
      const orders = snapshot.val() || {};
      allOrders = [];
      const tbody = document.querySelector('#orderTable tbody');
      tbody.innerHTML = '';

      Object.keys(orders).forEach(code => {
        const order = orders[code];
        allOrders.push({ code, ...order });

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${code}</td>
          <td><img src="assets/${order.image}" alt="${order.image}" class="product-img"></td>
          <td>₮${order.amount}</td>
          <td>${new Date(order.createdAt).toLocaleString('mn')}</td>
          <td><button class="btn-approve" onclick="approveOrder('${code}')">Зөвшөөрөх</button></td>
        `;
        tbody.appendChild(row);
      });
    });
  }

  // Зөвшөөрөгдсөн захиалгуудыг унших
  function loadApprovedOrders() {
    db.ref('approvedOrders').once('value').then(snapshot => {
      const orders = snapshot.val() || {};
      approvedOrders = [];
      const tbody = document.querySelector('#approvedOrderTable tbody');
      tbody.innerHTML = '';

      Object.keys(orders).forEach(code => {
        const order = orders[code];
        approvedOrders.push({ code, ...order });

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${code}</td>
          <td><img src="assets/${order.image}" alt="${order.image}" class="product-img"></td>
          <td>₮${order.amount}</td>
          <td>${new Date(order.createdAt).toLocaleString('mn')}</td>
        `;
        tbody.appendChild(row);
      });
    });
  }

  // Захиалгыг зөвшөөрөх функц
  function approveOrder(code) {
    db.ref('paymentCodes/' + code).once('value').then(snapshot => {
      const orderData = snapshot.val();
      if (!orderData) {
        alert("Захиалга олдсонгүй");
        return;
      }
      db.ref('approvedOrders/' + code).set(orderData).then(() => {
        db.ref('paymentCodes/' + code).remove().then(() => {
          alert("Захиалга зөвшөөрөгдлөө");
          loadOrders();
          loadApprovedOrders();
        });
      });
    });
  }

  // Хайлтын функц
  function searchOrders(query) {
    query = query.toLowerCase();
    // Зөвшөөрөгдөөгүй захиалгууд
    const tbodyOrders = document.querySelector('#orderTable tbody');
    tbodyOrders.innerHTML = '';
    allOrders.forEach(order => {
      if (
        order.code.toLowerCase().includes(query) ||
        order.amount.toString().includes(query)
      ) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${order.code}</td>
          <td><img src="assets/${order.image}" alt="${order.image}" class="product-img"></td>
          <td>₮${order.amount}</td>
          <td>${new Date(order.createdAt).toLocaleString('mn')}</td>
          <td><button class="btn-approve" onclick="approveOrder('${order.code}')">Зөвшөөрөх</button></td>
        `;
        tbodyOrders.appendChild(row);
      }
    });

    // Зөвшөөрөгдсөн захиалгууд
    const tbodyApproved = document.querySelector('#approvedOrderTable tbody');
    tbodyApproved.innerHTML = '';
    approvedOrders.forEach(order => {
      if (
        order.code.toLowerCase().includes(query) ||
        order.amount.toString().includes(query)
      ) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${order.code}</td>
          <td><img src="assets/${order.image}" alt="${order.image}" class="product-img"></td>
          <td>₮${order.amount}</td>
          <td>${new Date(order.createdAt).toLocaleString('mn')}</td>
        `;
        tbodyApproved.appendChild(row);
      }
    });
  }

  document.getElementById('search').addEventListener('input', e => {
    const val = e.target.value.trim();
    if (val === '') {
      loadOrders();
      loadApprovedOrders();
    } else {
      searchOrders(val);
    }
  });

  // Анхны ачаалалт
  loadOrders();
  loadApprovedOrders();

  // Realtime шинэчлэлтүүдийг хянах
  db.ref('paymentCodes').on('child_added', loadOrders);
  db.ref('paymentCodes').on('child_removed', loadOrders);
  db.ref('approvedOrders').on('child_added', loadApprovedOrders);
  db.ref('approvedOrders').on('child_removed', loadApprovedOrders);
</script>

</body>
</html>